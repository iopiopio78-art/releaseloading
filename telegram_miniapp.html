<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Label Mini App</title>
  <style>
    :root{
      --bg0:#070010; --bg1:#12002a; --card:#140625cc;
      --stroke:#4c1d95aa; --accent:#a78bfa; --accent2:#7c3aed;
      --text:#efeaff; --muted:#b8a7dd;
      --danger:#fb7185; --ok:#34d399;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(700px 420px at 80% 20%, rgba(167,139,250,.25), transparent 55%),
        radial-gradient(800px 520px at 50% 90%, rgba(76,29,149,.35), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    .wrap{
      width:100%;
      max-width:980px;
      margin:0 auto;
      padding:16px;
    }
    .shell{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(20,6,37,.65), rgba(10,0,22,.55));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    header{
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(167,139,250,.18);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.3px}
    .brand p{margin:4px 0 0; color:var(--muted); font-size:12px}
    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:12px 16px;
      border-bottom:1px solid rgba(167,139,250,.18);
      background: rgba(8,0,16,.35);
    }
    .tab{
      padding:10px 12px;
      border:1px solid rgba(167,139,250,.25);
      color:var(--text);
      border-radius:14px;
      background: rgba(20,6,37,.45);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border .12s ease;
    }
    .tab:hover{transform: translateY(-1px); border-color: rgba(167,139,250,.55)}
    .tab.active{background: rgba(124,58,237,.25); border-color: rgba(167,139,250,.75)}
    main{padding:16px}
    .card{
      border:1px solid rgba(167,139,250,.22);
      background: rgba(20,6,37,.55);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px -2px auto -2px; height:3px;
      background: linear-gradient(90deg, transparent, rgba(167,139,250,.85), transparent);
      opacity:.65;
      animation: glow 3.2s linear infinite;
    }
    @keyframes glow{0%{transform:translateX(-30%)}100%{transform:translateX(30%)}}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .row{grid-template-columns:1fr} .wrap{padding:12px} }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(167,139,250,.25);
      background: rgba(6,0,12,.55);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .btn{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(167,139,250,.45);
      background: linear-gradient(180deg, rgba(124,58,237,.35), rgba(76,29,149,.25));
      color:var(--text);
      cursor:pointer;
      transition: transform .12s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.secondary{background: rgba(20,6,37,.55)}
    .btn.danger{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12)}
    .hint{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.45}
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(10,0,22,.9);
      border:1px solid rgba(167,139,250,.35);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--shadow);
      max-width: min(520px, calc(100vw - 24px));
      display:none;
    }
    .grid3{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:720px){ .grid3{grid-template-columns:1fr 1fr} }
    .tool{
      padding:12px; border-radius:16px;
      border:1px solid rgba(167,139,250,.2);
      background: rgba(6,0,12,.35);
      cursor:pointer;
      transition: transform .12s ease;
    }
    .tool:hover{transform: translateY(-2px)}
    .tool h3{margin:0 0 6px; font-size:13px}
    .tool p{margin:0; font-size:12px; color:var(--muted)}
    .releaseItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px; border-radius:16px;
      border:1px solid rgba(167,139,250,.2);
      background: rgba(6,0,12,.35);
      margin-top:10px;
    }
    .releaseItem b{font-size:13px}
    .releaseItem small{display:block; color:var(--muted); margin-top:3px}
    .actions{display:flex; gap:8px}
    .mini{padding:10px 12px; border-radius:14px; border:1px solid rgba(167,139,250,.25); background: rgba(20,6,37,.45); color:var(--text); cursor:pointer}
    .mini.danger{border-color: rgba(251,113,133,.55); background: rgba(251,113,133,.12)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell">
      <header>
        <div class="brand">
          <h1>Label Manager Mini App</h1>
          <p id="sub">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–∑–æ–≤ ‚Ä¢ –æ—Ç—á—ë—Ç—ã ‚Ä¢ –≤—ã–ø–ª–∞—Ç—ã</p>
        </div>
        <button class="mini" id="btnClose">–ó–∞–∫—Ä—ã—Ç—å</button>
      </header>

      <div class="tabs" id="tabs"></div>

      <main>
        <!-- Upload -->
        <section id="page_upload" class="card">
          <div id="stepWrap"></div>
          <div style="margin-top:12px" class="row">
            <button class="btn secondary" id="prevBtn">–ù–∞–∑–∞–¥</button>
            <button class="btn" id="nextBtn">–î–∞–ª–µ–µ</button>
          </div>
          <p class="hint">–§–∞–π–ª—ã: –æ–±–ª–æ–∂–∫–∞ –∏ –∞—É–¥–∏–æ/–∞—Ä—Ö–∏–≤ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω—É –≤–º–µ—Å—Ç–µ —Å –¥–∞–Ω–Ω—ã–º–∏ —Ä–µ–ª–∏–∑–∞.</p>
        </section>

        <!-- My releases -->
        <section id="page_my" class="card hidden">
          <div class="row">
            <button class="btn" id="refreshMy">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <button class="btn secondary" id="toUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π</button>
          </div>
          <div id="myList" style="margin-top:10px"></div>
          <p class="hint">–ó–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–ª–∏–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –æ—Ç–ø—Ä–∞–≤–∏–ª(–∞). –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö –Ω–µ—Ç.</p>
        </section>

        <!-- About -->
        <section id="page_about" class="card hidden">
          <h2 style="margin:0 0 8px;font-size:16px">–û –ª–µ–π–±–ª–µ</h2>
          <p style="margin:0;color:var(--muted);line-height:1.5">
            –ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–≤–æ–π —Ç–µ–∫—Å—Ç: –∫—Ç–æ –≤—ã, —É—Å–ª–æ–≤–∏—è –ø—Ä–∏—ë–º–∞ –¥–µ–º–æ–∫, –∫–æ–Ω—Ç–∞–∫—Ç—ã A&R, –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –∏ —Ç.–¥.
          </p>
        </section>

        <!-- Tools -->
        <section id="page_tools" class="card hidden">
          <h2 style="margin:0 0 10px;font-size:16px">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
          <div class="grid3">
            <div class="tool" data-tool="–ü—Ä–æ–º–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞"><h3>–ü—Ä–æ–º–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</h3><p>–°–∫–æ—Ä–æ</p></div>
            <div class="tool" data-tool="–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏"><h3>–ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏</h3><p>–°–∫–æ—Ä–æ</p></div>
            <div class="tool" data-tool="–ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–ª–∏–∑–∞"><h3>–ü–µ—Ä–µ–Ω–æ—Å —Ä–µ–ª–∏–∑–∞</h3><p>–°–∫–æ—Ä–æ</p></div>
            <div class="tool" data-tool="UPC/ISRC"><h3>UPC / ISRC</h3><p>–°–∫–æ—Ä–æ</p></div>
            <div class="tool" data-tool="–í–∏–¥–µ–æ—à–æ—Ç"><h3>–í–∏–¥–µ–æ—à–æ—Ç</h3><p>–°–∫–æ—Ä–æ</p></div>
            <div class="tool" data-tool="–í–∏–¥–µ–æ –æ–±–ª–æ–∂–∫–∞"><h3>–í–∏–¥–µ–æ –æ–±–ª–æ–∂–∫–∞</h3><p>–°–∫–æ—Ä–æ</p></div>
          </div>
          <p class="hint">–ù–∞–∂–º–∏ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äú—Å–∫–æ—Ä–æ‚Äù, –∏ –¥–µ–π—Å—Ç–≤–∏–µ —É–π–¥—ë—Ç –∞–¥–º–∏–Ω—É.</p>
        </section>

        <!-- Reports -->
        <section id="page_reports" class="card hidden">
          <h2 style="margin:0 0 10px;font-size:16px">–û—Ç—á—ë—Ç—ã</h2>
          <div class="card" style="margin-bottom:12px">
            <pre style="white-space:pre-wrap;margin:0;color:var(--muted);font-family:inherit;line-height:1.5" id="reportsInfo"></pre>
          </div>

          <div class="row">
            <div class="card">
              <div style="color:var(--muted);font-size:12px">–í—Å–µ–≥–æ —Ä–µ–ª–∏–∑–æ–≤ –≤ –±–æ—Ç–µ</div>
              <div style="font-size:28px;margin-top:6px" id="countTotal">‚Äî</div>
            </div>
            <div class="card">
              <div style="color:var(--muted);font-size:12px">–ú–æ–∏—Ö —Ä–µ–ª–∏–∑–æ–≤</div>
              <div style="font-size:28px;margin-top:6px" id="countMine">‚Äî</div>
            </div>
          </div>

          <div style="margin-top:12px" class="row">
            <button class="btn" id="btnCounts">–û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏</button>
            <button class="btn secondary" id="btnReportReq">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ—Ç—á—ë—Ç</button>
          </div>

          <div id="reportForm" class="hidden" style="margin-top:12px">
            <label>–ù–∏–∫ –∞—Ä—Ç–∏—Å—Ç–∞</label>
            <input id="repNick" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: iopiopio78" />
            <label>–†–µ–ª–∏–∑ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="repTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞" />
            <label>–ü–µ—Ä–∏–æ–¥</label>
            <select id="repPeriod">
              <option value="I –∫–≤–∞—Ä—Ç–∞–ª">I –∫–≤–∞—Ä—Ç–∞–ª</option>
              <option value="II –∫–≤–∞—Ä—Ç–∞–ª">II –∫–≤–∞—Ä—Ç–∞–ª</option>
              <option value="III –∫–≤–∞—Ä—Ç–∞–ª">III –∫–≤–∞—Ä—Ç–∞–ª</option>
              <option value="IV –∫–≤–∞—Ä—Ç–∞–ª">IV –∫–≤–∞—Ä—Ç–∞–ª</option>
              <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
            </select>
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="repComment" placeholder="–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ, –∫–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã, —É—Ç–æ—á–Ω–µ–Ω–∏—è"></textarea>
            <button class="btn" id="sendReport">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
          </div>
        </section>

        <!-- Payouts -->
        <section id="page_payouts" class="card hidden">
          <h2 style="margin:0 0 10px;font-size:16px">–í—ã–ø–ª–∞—Ç—ã</h2>
          <div class="card" style="margin-bottom:12px">
            <pre style="white-space:pre-wrap;margin:0;color:var(--muted);font-family:inherit;line-height:1.5" id="payoutsInfo"></pre>
          </div>

          <div class="row">
            <button class="btn" id="btnLoadForPayout">–í—ã–±—Ä–∞—Ç—å —Ä–µ–ª–∏–∑—ã –¥–ª—è –≤—ã–≤–æ–¥–∞</button>
            <button class="btn secondary" id="btnPayoutSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
          </div>

          <div id="payoutBox" class="hidden" style="margin-top:12px">
            <div id="payoutList"></div>
            <label>–ö–æ—à–µ–ª—ë–∫/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="payWallet" placeholder="–∫–∞—Ä—Ç–∞/USDT/—Ä–µ–∫–≤–∏–∑–∏—Ç—ã" />
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea id="payComment" placeholder="–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>
          </div>

          <p class="hint">–†–µ–ª–∏–∑—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ ‚Äú–ú–æ–∏ —Ä–µ–ª–∏–∑—ã‚Äù.</p>
        </section>
      </main>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.expand();

  const REPORTS_INFO = `–°–µ—Ä–≤–∏—Å—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –Ω–∞–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–æ –≤—ã–ø–ª–∞—Ç—ã —Ä–æ—è–ª—Ç–∏, —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ —è–≤–ª—è—é—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–∞–∂–∞—é—Ç —á–∏—Å–ª–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–π.

–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —Å–µ—Ä–≤–∏—Å–æ–≤ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, –û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏ (–û–ú–ê), Spotify, SoundCloud, Apple Music, Yandex.Music

–ì—Ä–∞—Ñ–∏–∫ –ø–æ–ª–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤:

I –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 —è–Ω–≤–∞—Ä—è –ø–æ 31 –º–∞—Ä—Ç–∞ - –æ—Ç—á–µ—Ç—ã —Å 3 –∞–ø—Ä–µ–ª—è

II –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –∞–ø—Ä–µ–ª—è –ø–æ 30 –∏—é–Ω—è - –æ—Ç—á–µ—Ç—ã —Å 3 –∏—é–ª—è

III –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –∏—é–ª—è –ø–æ 30 —Å–µ–Ω—Ç—è–±—Ä—è - –æ—Ç—á–µ—Ç—ã —Å 3 –æ–∫—Ç—è–±—Ä—è

IV –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –æ–∫—Ç—è–±—Ä—è –ø–æ 31 –¥–µ–∫–∞–±—Ä—è - –æ—Ç—á–µ—Ç—ã —Å 3 —è–Ω–≤–∞—Ä—è

–ß—Ç–æ –¥–µ–ª–∞–µ–º?ÔªøüëáÔªø`;

  const PAYOUTS_INFO = `–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç –æ—Ç—á–µ—Ç—ã —Ä–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª, –≤ —Å–≤—è–∑–∏ —Å —á–µ–º —Å –º–∞—Ä—Ç–∞ 2023 –≥–æ–¥–∞ –º—ã —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ –µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω—É—é –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –∏ –≤—ã–ø–ª–∞—Ç—ã.

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—ã–ø–ª–∞—Ç—ã –∏ –æ—Ç—á–µ—Ç—ã –ø–æ—Å—Ç—É–ø–∞—é—Ç 4 —Ä–∞–∑–∞ –≤ –≥–æ–¥ –≤ —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Å—è—Ü—ã: —Ñ–µ–≤—Ä–∞–ª—å (–∑–∞ –æ—Å–µ–Ω—å), –º–∞–π (–∑–∞ –∑–∏–º—É), –∞–≤–≥—É—Å—Ç (–∑–∞ –≤–µ—Å–Ω—É), –Ω–æ—è–±—Ä—å (–∑–∞ –ª–µ—Ç–æ).

–ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç:

I –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 —è–Ω–≤–∞—Ä—è –ø–æ 31 –º–∞—Ä—Ç–∞ - –≤—ã–ø–ª–∞—Ç—ã —Å 15 –º–∞—è

II –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –∞–ø—Ä–µ–ª—è –ø–æ 30 –∏—é–Ω—è - –≤—ã–ø–ª–∞—Ç—ã —Å 15 –∞–≤–≥—É—Å—Ç–∞

III –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –∏—é–ª—è –ø–æ 30 —Å–µ–Ω—Ç—è–±—Ä—è - –≤—ã–ø–ª–∞—Ç—ã —Å 15 –Ω–æ—è–±—Ä—è

IV –∫–≤–∞—Ä—Ç–∞–ª - —Å 1 –æ–∫—Ç—è–±—Ä—è –ø–æ 31 –¥–µ–∫–∞–±—Ä—è - –≤—ã–ø–ª–∞—Ç—ã —Å 15 —Ñ–µ–≤—Ä–∞–ª—è

–ß—Ç–æ –¥–µ–ª–∞–µ–º?ÔªøüëáÔªø`;

  const pages = [
    {id:"upload",  title:"–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–ª–∏–∑"},
    {id:"my",      title:"–ú–æ–∏ —Ä–µ–ª–∏–∑—ã"},
    {id:"about",   title:"–û –ª–µ–π–±–ª–µ"},
    {id:"tools",   title:"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"},
    {id:"reports", title:"–û—Ç—á—ë—Ç—ã"},
    {id:"payouts", title:"–í—ã–ø–ª–∞—Ç—ã"},
  ];

  const state = {
    page:"upload",
    step:0,
    release:{
      artistNick:"",
      releaseTitle:"",
      link:"",
      comment:"",
      coverB64:"",
      audioB64:"",
    },
    myReleases: [],
    payoutSelected: new Set()
  };

  const $ = (id)=>document.getElementById(id);
  const toast = (t)=>{ const el=$("toast"); el.textContent=t; el.style.display="block"; clearTimeout(window.__tt); window.__tt=setTimeout(()=>el.style.display="none",2200); };
  const send = (obj)=>{
    try{
      if(!tg) { console.log("send", obj); toast("–û—Ç–∫—Ä–æ–π –≤ Telegram"); return; }
      tg.sendData(JSON.stringify(obj)); // sendData -> bot gets web_app_data [web:35]
      toast("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    }catch(e){ console.error(e); toast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
  };

  // Tabs
  const tabsEl = $("tabs");
  pages.forEach(p=>{
    const b=document.createElement("div");
    b.className="tab";
    b.textContent=p.title;
    b.onclick=()=>go(p.id);
    b.dataset.page=p.id;
    tabsEl.appendChild(b);
  });
  function renderTabs(){
    [...tabsEl.children].forEach(x=>x.classList.toggle("active", x.dataset.page===state.page));
  }
  function go(page){
    state.page=page;
    ["upload","my","about","tools","reports","payouts"].forEach(pid=>{
      $("page_"+pid).classList.toggle("hidden", pid!==page);
    });
    if(page==="reports"){
      $("reportsInfo").textContent = REPORTS_INFO;
    }
    if(page==="payouts"){
      $("payoutsInfo").textContent = PAYOUTS_INFO;
    }
    renderTabs();
  }
  go("upload");

  // Step form (upload)
  const steps = [
    {k:"artistNick",   title:"–®–∞–≥ 1/5 ‚Äî –ù–∏–∫ –∞—Ä—Ç–∏—Å—Ç–∞",    type:"input", ph:"–Ω–∞–ø—Ä–∏–º–µ—Ä: iopiopio78", req:true},
    {k:"releaseTitle", title:"–®–∞–≥ 2/5 ‚Äî –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞",type:"input", ph:"–Ω–∞–ø—Ä–∏–º–µ—Ä: Night Drive EP", req:true},
    {k:"link",         title:"–®–∞–≥ 3/5 ‚Äî –°—Å—ã–ª–∫–∞",         type:"input", ph:"Drive/SoundCloud/Dropbox (–µ—Å–ª–∏ –µ—Å—Ç—å)", req:false},
    {k:"comment",      title:"–®–∞–≥ 4/5 ‚Äî –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",    type:"textarea", ph:"–∂–∞–Ω—Ä, BPM, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã, —É—Å–ª–æ–≤–∏—è", req:false},
    {k:"files",        title:"–®–∞–≥ 5/5 ‚Äî –§–∞–π–ª—ã",          type:"files", req:false},
  ];

  function renderStep(){
    const s=steps[state.step];
    const wrap=$("stepWrap");
    wrap.innerHTML = `<h2 style="margin:0 0 10px;font-size:16px">${s.title}</h2>`;
    const val = state.release[s.k] || "";

    if(s.type==="input"){
      wrap.innerHTML += `<label>${s.req?"–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ":"–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"}</label>
        <input id="stepInput" placeholder="${s.ph}" value="${escapeHtml(val)}">`;
    }else if(s.type==="textarea"){
      wrap.innerHTML += `<label>${s.req?"–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ":"–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"}</label>
        <textarea id="stepInput" placeholder="${s.ph}">${escapeHtml(val)}</textarea>`;
    }else{
      wrap.innerHTML += `
        <div class="row">
          <div>
            <label>–û–±–ª–æ–∂–∫–∞ (jpg/png)</label>
            <input type="file" id="coverFile" accept="image/*">
          </div>
          <div>
            <label>–ê—É–¥–∏–æ/–∞—Ä—Ö–∏–≤ (mp3/wav/zip)</label>
            <input type="file" id="audioFile" accept=".mp3,.wav,.zip,audio/*">
          </div>
        </div>
        <p class="hint">–ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–æ–π ‚Äî –ª—É—á—à–µ zip. –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–¥—ë—Ç –∫–∞–∫ base64.</p>
      `;
    }

    $("prevBtn").textContent = (state.step===0) ? "–í –º–µ–Ω—é" : "–ù–∞–∑–∞–¥";
    $("nextBtn").textContent = (state.step===steps.length-1) ? "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" : "–î–∞–ª–µ–µ";
  }

  function escapeHtml(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

  $("prevBtn").onclick=()=>{
    if(state.step===0){ go("my"); return; }
    state.step--; renderStep();
  };

  $("nextBtn").onclick=async ()=>{
    const s=steps[state.step];

    if(s.type==="input" || s.type==="textarea"){
      const v = ($("stepInput").value || "").trim();
      if(s.req && !v){ toast("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª–µ"); return; }
      state.release[s.k]=v;
      state.step++;
      renderStep();
      return;
    }

    // files step
    const cover = $("coverFile").files?.[0];
    const audio = $("audioFile").files?.[0];

    if(cover) state.release.coverB64 = await fileToDataUrl(cover);
    if(audio) state.release.audioB64 = await fileToDataUrl(audio);

    // Submit
    if(!state.release.artistNick || !state.release.releaseTitle){
      toast("–ù–∏–∫ –∏ –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
      return;
    }

    send({action:"submit_release", ...state.release});

    // Reset form
    state.step=0;
    state.release = {artistNick:"",releaseTitle:"",link:"",comment:"",coverB64:"",audioB64:""};
    renderStep();
    go("my");
  };

  async function fileToDataUrl(file){
    return new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  renderStep();

  // My releases (stored locally only as cache; real list should be from your backend, here we keep it simple)
  function renderMy(){
    const box=$("myList");
    box.innerHTML="";
    if(state.myReleases.length===0){
      box.innerHTML = `<div class="card"><div style="color:var(--muted)">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ ‚Äú–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π‚Äù.</div></div>`;
      return;
    }
    state.myReleases.forEach(r=>{
      const el=document.createElement("div");
      el.className="releaseItem";
      el.innerHTML = `
        <div>
          <b>${escapeHtml(r.releaseTitle)}</b>
          <small>${escapeHtml(r.artistNick)} ‚Ä¢ ID ${r.id}</small>
        </div>
        <div class="actions">
          <button class="mini danger">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      el.querySelector("button").onclick=()=>openDelete(r);
      box.appendChild(el);
    });
  }

  // For this version, we keep "my releases" as local cache + refresh from server by asking bot.
  $("refreshMy").onclick=()=>{
    send({action:"list_releases"});
    toast("–ó–∞–ø—Ä–æ—Å —Å–ø–∏—Å–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –ø–æ—Å–ª–µ —Å–∏–Ω–∫–∞.");
  };
  $("toUpload").onclick=()=>{ state.step=0; renderStep(); go("upload"); };

  // Delete form (inline prompt)
  function openDelete(r){
    const reason = prompt(`–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–ª–∏–∑–∞:\n${r.artistNick} ‚Äî ${r.releaseTitle}`);
    if(!reason || !reason.trim()){ toast("–ù—É–∂–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞"); return; }
    send({
      action:"request_delete",
      releaseId:r.id,
      artistNick:r.artistNick,
      releaseTitle:r.releaseTitle,
      reason: reason.trim()
    });
    // remove from UI immediately
    state.myReleases = state.myReleases.filter(x=>x.id!==r.id);
    renderMy();
  }

  // Tools
  document.querySelectorAll(".tool").forEach(x=>{
    x.onclick=()=>{
      const name=x.dataset.tool;
      toast("–°–∫–æ—Ä–æ!");
      send({action:"tool_click", tool:name});
    };
  });

  // Reports counts + request form
  $("btnCounts").onclick=()=>{
    send({action:"get_counts"});
    // counts are answered by bot in chat; if —Ç—ã —Ö–æ—á–µ—à—å –ø—Ä—è–º–æ –≤ –º–∏–Ω–∏–∞–ø–ø ‚Äî –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π API, —Ç—É—Ç –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ —á–∞—Ç.
    toast("–°—á—ë—Ç—á–∏–∫–∏ –ø—Ä–∏–¥—É—Ç –≤ —á–∞—Ç");
  };
  $("btnReportReq").onclick=()=> $("reportForm").classList.toggle("hidden");

  $("sendReport").onclick=()=>{
    const artistNick=($("repNick").value||"").trim();
    const releaseTitle=($("repTitle").value||"").trim();
    const period=$("repPeriod").value;
    const comment=($("repComment").value||"").trim();
    if(!artistNick){ toast("–ù—É–∂–µ–Ω –Ω–∏–∫"); return; }
    send({action:"request_report", artistNick, releaseTitle, period, comment});
    $("repNick").value=""; $("repTitle").value=""; $("repComment").value="";
    $("reportForm").classList.add("hidden");
  };

  // Payouts
  $("btnLoadForPayout").onclick=()=>{
    $("payoutBox").classList.remove("hidden");
    renderPayoutList();
  };

  function renderPayoutList(){
    const box=$("payoutList");
    box.innerHTML="";
    if(state.myReleases.length===0){
      box.innerHTML=`<div class="card"><div style="color:var(--muted)">–ù–µ—Ç —Ä–µ–ª–∏–∑–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞.</div></div>`;
      return;
    }
    state.payoutSelected = new Set();
    state.myReleases.forEach(r=>{
      const id="chk_"+r.id;
      const el=document.createElement("div");
      el.className="releaseItem";
      el.innerHTML=`
        <div>
          <b>${escapeHtml(r.releaseTitle)}</b>
          <small>${escapeHtml(r.artistNick)} ‚Ä¢ ID ${r.id}</small>
        </div>
        <div class="actions">
          <input type="checkbox" id="${id}" />
        </div>
      `;
      el.querySelector("input").onchange=(e)=>{
        if(e.target.checked) state.payoutSelected.add(r.id);
        else state.payoutSelected.delete(r.id);
      };
      box.appendChild(el);
    });
  }

  $("btnPayoutSend").onclick=()=>{
    if($("payoutBox").classList.contains("hidden")) $("payoutBox").classList.remove("hidden");
    const releases=[...state.payoutSelected];
    const wallet=($("payWallet").value||"").trim();
    const comment=($("payComment").value||"").trim();
    if(releases.length===0){ toast("–í—ã–±–µ—Ä–∏ —Ä–µ–ª–∏–∑—ã"); return; }
    send({action:"request_payout", releases, wallet, comment});
    $("payWallet").value=""; $("payComment").value="";
    state.payoutSelected=new Set();
    toast("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
  };

  // Close
  $("btnClose").onclick=()=>{ if(tg) tg.close(); };

  // Minimal local cache: when user submits, add to my releases list as ‚Äúnew‚Äù
  // In real world we sync from DB. Here we keep UI responsive.
  window.addEventListener("message", (e)=>{});
  // Note: bot cannot push data back into webapp without extra backend; so "my releases" stays local cache in this simple build.
</script>
</body>
</html>