<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KILLA! RECORDS ‚Äî Mini App</title>

  <!-- Telegram Mini Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js?59"></script>

  <style>
    :root { color-scheme: light dark; }

    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(130,84,255,.20), transparent 55%),
        radial-gradient(1000px 700px at 90% 20%, rgba(0,190,255,.18), transparent 55%),
        radial-gradient(900px 650px at 40% 95%, rgba(255,70,160,.14), transparent 55%),
        var(--tg-theme-bg-color, #0b0e14);
      color: var(--tg-theme-text-color, #eaf0ff);
      overflow-x:hidden;
    }

    .app{
      padding-bottom: calc(72px + var(--tg-safe-area-inset-bottom, 0px));
    }

    .topbar{
      position: sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(8,10,16,.86), rgba(8,10,16,.35));
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 12px 14px 10px;
    }
    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brand .t1{ font-weight: 900; letter-spacing: .2px; font-size: 16px; }
    .brand .t2{ font-size: 12px; opacity:.72; margin-top:2px; }

    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background:#2ea6ff; box-shadow:0 0 0 3px rgba(46,166,255,.20); }
    .dot.red{ background:#ff4d8a; box-shadow:0 0 0 3px rgba(255,77,138,.20); }
    .dot.green{ background:#00d38b; box-shadow:0 0 0 3px rgba(0,211,139,.20); }

    .wrap{ padding: 14px; max-width: 920px; margin:0 auto; }

    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      overflow:auto;
      padding: 10px 0 2px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      flex:0 0 auto;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      outline: 2px solid rgba(46,166,255,.35);
      background: rgba(46,166,255,.10);
    }

    .search{
      display:flex;
      gap:10px;
      margin: 12px 0 8px;
      align-items:center;
    }
    .search input{
      flex:1;
      border-radius: 16px;
      padding: 12px 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:inherit;
      outline:none;
      font-weight: 650;
    }
    .btn{
      border:0;
      border-radius: 16px;
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 900;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
    }
    .btn.secondary{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      color: var(--tg-theme-text-color, #fff);
      font-weight: 800;
    }
    .btn.danger{
      background: rgba(255,77,138,.12);
      border:1px solid rgba(255,77,138,.22);
      color: #ffd2e1;
    }

    .card{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      padding: 14px;
      margin-bottom: 12px;
      overflow:hidden;
    }
    .card .h{
      font-weight: 950;
      letter-spacing: .2px;
      margin: 0 0 10px;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{
      opacity:.74;
      font-size: 13px;
      line-height: 1.35;
    }

    .banner{
      position:relative;
      border-radius: 20px;
      padding: 16px 16px 14px;
      background:
        radial-gradient(800px 220px at 10% 30%, rgba(130,84,255,.35), transparent 50%),
        radial-gradient(700px 240px at 90% 60%, rgba(0,190,255,.30), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
    }
    .banner .big{
      font-weight: 950;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width:720px){ .grid2{ grid-template-columns: 1fr; } }

    label{ display:block; margin: 10px 0 6px; font-size: 12px; opacity:.72; }
    input, textarea, select{
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:inherit;
      outline:none;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .list .item{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.15);
      padding: 12px;
      margin-top: 10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .badge{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-weight: 850;
      text-transform: lowercase;
    }
    .badge.pending{ border-color: rgba(255,200,90,.30); background: rgba(255,200,90,.10); color: #ffe9b9; }
    .badge.approved{ border-color: rgba(0,211,139,.30); background: rgba(0,211,139,.10); color: #c9ffef; }
    .badge.rejected{ border-color: rgba(255,77,138,.30); background: rgba(255,77,138,.12); color: #ffd2e1; }

    .split{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .split > *{ flex:1; min-width: 210px; }

    .bottomnav{
      position: fixed;
      left:0; right:0;
      bottom:0;
      z-index: 60;
      padding-bottom: var(--tg-safe-area-inset-bottom, 0px);
      backdrop-filter: blur(16px);
      background: rgba(8,10,16,.78);
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .bottomnav .bar{
      display:flex;
      max-width: 920px;
      margin:0 auto;
      padding: 8px 10px 10px;
      gap: 6px;
    }
    .navbtn{
      flex:1;
      border-radius: 16px;
      padding: 10px 8px;
      border:1px solid transparent;
      background: transparent;
      color: inherit;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      font-weight: 850;
      font-size: 11px;
      opacity: .75;
      user-select:none;
    }
    .navbtn.active{
      opacity: 1;
      background: rgba(46,166,255,.10);
      border-color: rgba(46,166,255,.18);
    }
    .icon{
      width: 22px; height: 22px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size: 13px;
    }

    .hidden{ display:none !important; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(88px + var(--tg-safe-area-inset-bottom, 0px));
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      max-width: 92vw;
      font-size: 13px;
      z-index: 80;
      backdrop-filter: blur(10px);
      display:none;
    }
    code{ background: rgba(0,0,0,.25); padding: 1px 6px; border-radius: 8px; }
  </style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div class="toprow">
      <div class="brand">
        <div class="t1">KILLA! RECORDS</div>
        <div class="t2" id="who">Mini App ‚Ä¢ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</div>
      </div>
      <div class="chip" id="apiChip">
        <span class="dot red" id="apiDot"></span>
        <span id="apiText">API: offline</span>
      </div>
    </div>

    <div class="tabs" id="topTabs">
      <div class="tab active" data-tab="home">–ì–ª–∞–≤–Ω–∞—è</div>
      <div class="tab" data-tab="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
      <div class="tab" data-tab="releases">–ú–æ–∏ —Ä–µ–ª–∏–∑—ã</div>
      <div class="tab" data-tab="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="tab" data-tab="payout">–í—ã–ø–ª–∞—Ç–∞</div>
    </div>
  </div>

  <div class="wrap">

    <!-- HOME -->
    <section id="tab-home">
      <div class="banner">
        <div class="big">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</div>
        <div class="muted">
          –£–ø—Ä–∞–≤–ª—è–π —Ä–µ–ª–∏–∑–∞–º–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –≤—ã–ø–ª–∞—Ç–∞–º–∏ –ø—Ä—è–º–æ –≤ Mini App ‚Äî –≤—Å—ë —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –±–æ—Ç–æ–º.
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn" id="btnQuickSubmit">–ü–æ–¥–∞—Ç—å —Ä–µ–ª–∏–∑</button>
          <button class="btn secondary" id="btnQuickReload">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="search">
        <input id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–∏–º —Ä–µ–ª–∏–∑–∞–º..." />
        <button class="btn secondary" id="btnSearch">–ù–∞–π—Ç–∏</button>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="h">–°–≤–æ–¥–∫–∞ <span class="badge" id="sumBadge">‚Äî</span></div>
          <div class="muted" id="summaryText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="card">
          <div class="h">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
          <div class="row" style="gap:10px; margin-top:8px;">
            <button class="btn secondary" id="btnGoReleases">–ú–æ–∏ —Ä–µ–ª–∏–∑—ã</button>
            <button class="btn secondary" id="btnGoStats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
            <button class="btn secondary" id="btnGoPayout">–í—ã–ø–ª–∞—Ç–∞</button>
          </div>
          <div class="muted" style="margin-top:10px;">
            –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—å <code>API_BASE</code> –∏ HTTPS.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–ª–∏–∑—ã</div>
        <div class="list" id="homeLastList"></div>
      </div>
    </section>

    <!-- SUBMIT -->
    <section id="tab-submit" class="hidden">
      <div class="card">
        <div class="h">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–ª–∏–∑–∞</div>
        <div class="muted">
          –ü—Ä–∞–≤–∏–ª–∞ –Ω–∞–∑–≤–∞–Ω–∏–π:
          ‚Ä¢ Single: <b>–Ω–∏–∫ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</b>
          ‚Ä¢ Album/EP/Mixtape: <b>–Ω–∏–∫ ‚Äî –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞</b> + —Ç—Ä–µ–∫–ª–∏—Å—Ç ‚Äú1) –Ω–∏–∫ - –Ω–∞–∑–≤‚Äù
        </div>

        <div class="split" style="margin-top:10px;">
          <div>
            <label>–¢–∏–ø —Ä–µ–ª–∏–∑–∞</label>
            <select id="s_type">
              <option>Single</option>
              <option>EP</option>
              <option>Album</option>
              <option>Mixtape</option>
            </select>
          </div>
          <div>
            <label>–ñ–∞–Ω—Ä</label>
            <select id="s_genre">
              <option>Hip-Hop</option>
              <option>Trap</option>
              <option>Drill</option>
              <option>Cloud Rap</option>
              <option>Witch House</option>
              <option>Phonk</option>
              <option>–î—Ä—É–≥–æ–µ</option>
            </select>
          </div>
        </div>

        <label>–ù–∏–∫ –∞—Ä—Ç–∏—Å—Ç–∞</label>
        <input id="s_artist" placeholder="–Ω–∏–∫ / @artist" />

        <label id="s_title_lbl">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="s_title" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ" />

        <label>–§–ò–û –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ç—Ä–µ–∫–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="s_fio" placeholder="–§–ò–û –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" />

        <div class="split">
          <div>
            <label>–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ (–î–î.–ú–ú.–ì–ì–ì–ì)</label>
            <input id="s_date" placeholder="18.02.2026" />
          </div>
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤</label>
            <input id="s_tracks" type="number" min="1" step="1" value="1" />
          </div>
        </div>

        <label>–¢—Ä–µ–∫–ª–∏—Å—Ç (—Ä–æ–≤–Ω–æ N —Å—Ç—Ä–æ–∫)</label>
        <textarea id="s_tracklist" placeholder="1) –Ω–∏–∫ - –Ω–∞–∑–≤&#10;2) –Ω–∏–∫ - –Ω–∞–∑–≤"></textarea>
        <button class="btn secondary" id="btnAutoTracklist">–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å (Single)</button>

        <label>–û–±–ª–æ–∂–∫–∞ (—Ñ–æ—Ç–æ JPG/PNG)</label>
        <input id="s_cover" type="file" accept="image/*" />

        <label>–ê—É–¥–∏–æ (—Ä–æ–≤–Ω–æ N —Ñ–∞–π–ª–æ–≤)</label>
        <input id="s_audio" type="file" accept="audio/*" multiple />

        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="s_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

        <button class="btn" id="btnSubmitRelease">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–ª–∏–∑</button>
        <button class="btn secondary" id="btnClearRelease">–û—á–∏—Å—Ç–∏—Ç—å</button>

        <div class="muted" id="submitStatus" style="margin-top:10px;">‚Äî</div>
      </div>
    </section>

    <!-- RELEASES -->
    <section id="tab-releases" class="hidden">
      <div class="card">
        <div class="h">–ú–æ–∏ —Ä–µ–ª–∏–∑—ã</div>
        <div class="row">
          <button class="btn secondary" id="btnReloadReleases">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn secondary" id="btnReloadReleases2">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ</button>
        </div>
        <div class="list" id="releasesList"></div>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats" class="hidden">
      <div class="card">
        <div class="h">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div class="muted">–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑—É –∏ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç –∞–¥–º–∏–Ω—É —Ç–∞–∫ –∂–µ, –∫–∞–∫ –∏–∑ –±–æ—Ç–∞.</div>

        <label>–ê—Ä—Ç–∏—Å—Ç</label>
        <input id="st_artist" placeholder="–ê—Ä—Ç–∏—Å—Ç" />

        <label>–†–µ–ª–∏–∑</label>
        <input id="st_release" placeholder="–†–µ–ª–∏–∑" />

        <label>–°—Ç—Ä–∏–º—ã</label>
        <input id="st_streams" placeholder="12 345" />

        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="st_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

        <button class="btn" id="btnSendStats">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <div class="muted" id="statsStatus" style="margin-top:10px;">‚Äî</div>
      </div>
    </section>

    <!-- PAYOUT -->
    <section id="tab-payout" class="hidden">
      <div class="card">
        <div class="h">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É</div>
        <div class="muted">–î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–µ–ª–∏–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º <b>approved</b>.</div>

        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="btnLoadApproved">–ó–∞–≥—Ä—É–∑–∏—Ç—å approved</button>
          <button class="btn secondary" id="btnSelectAllApproved">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
        </div>

        <div class="list" id="approvedList"></div>

        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
        <textarea id="po_comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

        <button class="btn" id="btnSendPayout">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <div class="muted" id="payoutStatus" style="margin-top:10px;">‚Äî</div>
      </div>
    </section>

  </div>
</div>

<div class="bottomnav">
  <div class="bar">
    <button class="navbtn active" data-tab="home"><span class="icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
    <button class="navbtn" data-tab="releases"><span class="icon">üéµ</span><span>–†–µ–ª–∏–∑—ã</span></button>
    <button class="navbtn" data-tab="submit"><span class="icon">Ôºã</span><span>–ó–∞–≥—Ä—É–∑–∏—Ç—å</span></button>
    <button class="navbtn" data-tab="stats"><span class="icon">üìä</span><span>–°—Ç–∞—Ç—ã</span></button>
    <button class="navbtn" data-tab="payout"><span class="icon">üí∞</span><span>–í—ã–ø–ª–∞—Ç–∞</span></button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_BASE = "https://YOUR-DOMAIN.TLD"; // <-- –ø–æ—Å—Ç–∞–≤—å —Å–≤–æ–π https API (–±–µ–∑ / –≤ –∫–æ–Ω—Ü–µ)

  // =========================
  // TELEGRAM
  // =========================
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> el.style.display="none", 2200);
  }

  function initTelegramUI(){
    if(!tg){
      document.getElementById("who").textContent = "–û—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram (–¥–ª—è —Ç–µ—Å—Ç–∞)";
      return;
    }
    tg.ready();
    tg.expand();
    try{
      tg.setHeaderColor("secondary_bg_color");
      tg.setBackgroundColor("bg_color");
      if(tg.setBottomBarColor) tg.setBottomBarColor("bottom_bar_bg_color");
    }catch(e){}

    const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
    const name = u ? [u.first_name, u.last_name].filter(Boolean).join(" ") : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
    const uname = u && u.username ? "@"+u.username : "–±–µ–∑ username";
    document.getElementById("who").textContent = name + " ‚Ä¢ " + uname;
  }

  function initDataHeader(){
    // Always use initData for server-side verification
    return tg ? (tg.initData || "") : "";
  }

  // =========================
  // API
  // =========================
  async function apiGet(path){
    const res = await fetch(API_BASE + path, {
      method: "GET",
      headers: { "X-Telegram-Init-Data": initDataHeader() }
    });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  async function apiPostJSON(path, body){
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Telegram-Init-Data": initDataHeader()
      },
      body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  async function apiPostMultipart(path, formData){
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "X-Telegram-Init-Data": initDataHeader() },
      body: formData
    });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  }

  async function pingApi(){
    try{
      const r = await apiGet("/health");
      if(r && r.ok){
        setApiStatus(true);
        return true;
      }
      setApiStatus(false);
      return false;
    }catch(e){
      setApiStatus(false);
      return false;
    }
  }

  function setApiStatus(ok){
    const dot = document.getElementById("apiDot");
    const text = document.getElementById("apiText");
    if(ok){
      dot.classList.remove("red");
      dot.classList.add("green");
      text.textContent = "API: online";
    } else {
      dot.classList.remove("green");
      dot.classList.add("red");
      text.textContent = "API: offline";
    }
  }

  // =========================
  // NAV
  // =========================
  function showTab(name){
    for(const t of ["home","submit","releases","stats","payout"]){
      document.getElementById("tab-"+t).classList.toggle("hidden", t!==name);
    }
    document.querySelectorAll(".tab").forEach(x => x.classList.toggle("active", x.dataset.tab===name));
    document.querySelectorAll(".navbtn").forEach(x => x.classList.toggle("active", x.dataset.tab===name));
    window.scrollTo({top:0, behavior:"smooth"});
  }

  document.querySelectorAll(".tab").forEach(el => el.addEventListener("click", () => showTab(el.dataset.tab)));
  document.querySelectorAll(".navbtn").forEach(el => el.addEventListener("click", () => showTab(el.dataset.tab)));

  // =========================
  // RELEASES UI
  // =========================
  function badgeClass(status){
    if(status==="approved") return "approved";
    if(status==="pending") return "pending";
    if(status==="rejected") return "rejected";
    return "";
  }

  function releaseItemHTML(r){
    return `
      <div class="item">
        <div class="row">
          <div style="font-weight:950">${escapeHtml(r.release_title || "‚Äî")}</div>
          <span class="badge ${badgeClass(r.status)}">${escapeHtml(r.status || "‚Äî")}</span>
        </div>
        <div class="muted" style="margin-top:6px;">ID: <code>#${r.id}</code> ‚Ä¢ ${escapeHtml(r.created_at || "")}</div>
        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" data-open-release="${r.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="btn danger" data-del-release="${r.id}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  async function loadReleases(targetListId, limit=10){
    const list = document.getElementById(targetListId);
    list.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
    try{
      const r = await apiGet("/releases");
      const arr = (r.releases || []).slice(0, limit);
      if(!arr.length){
        list.innerHTML = `<div class="muted">–ü–æ–∫–∞ –ø—É—Å—Ç–æ.</div>`;
        return;
      }
      list.innerHTML = arr.map(releaseItemHTML).join("");
      wireReleaseButtons(list);
      updateSummary(r.releases || []);
    }catch(e){
      list.innerHTML = `<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å API_BASE/HTTPS.</div>`;
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–ª–∏–∑—ã");
    }
  }

  function wireReleaseButtons(container){
    container.querySelectorAll("[data-open-release]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rid = btn.getAttribute("data-open-release");
        await openReleaseModal(Number(rid));
      });
    });
    container.querySelectorAll("[data-del-release]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const rid = Number(btn.getAttribute("data-del-release"));
        await requestDelete(rid);
      });
    });
  }

  async function openReleaseModal(rid){
    try{
      const r = await apiGet("/release/" + rid);
      const rel = r.release;
      const aud = r.audio_files || [];
      const tracks = aud.map(x => `${x.track_number}. ${x.file_name || ""}`).join("\n") || "‚Äî";

      const msg =
        `#${rel.id}\n` +
        `–¢–∏–ø: ${rel.release_type}\n` +
        `–ê—Ä—Ç–∏—Å—Ç: ${rel.artist_nick}\n` +
        `–ù–∞–∑–≤–∞–Ω–∏–µ: ${rel.release_title}\n` +
        `–§–ò–û: ${rel.participants_fio}\n` +
        `–ñ–∞–Ω—Ä: ${rel.genre}\n` +
        `–î–∞—Ç–∞: ${rel.release_date}\n` +
        `–¢—Ä–µ–∫–æ–≤: ${rel.tracks_count}\n` +
        `–°—Ç–∞—Ç—É—Å: ${rel.status}\n\n` +
        `–¢—Ä–µ–∫–ª–∏—Å—Ç:\n${rel.tracklist_text || "‚Äî"}\n\n` +
        `–§–∞–π–ª—ã:\n${tracks}`;

      if(tg && tg.showPopup){
        tg.showPopup({
          title: "–†–µ–ª–∏–∑",
          message: msg.slice(0, 240), // popup is short; for full show alert
          buttons: [{id:"full", type:"default", text:"–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é"}, {type:"close"}]
        }, (id)=>{
          if(id==="full") tg.showAlert(msg);
        });
      } else {
        alert(msg);
      }
    }catch(e){
      toast("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–ª–∏–∑–∞");
    }
  }

  async function requestDelete(rid){
    const ask = async () => {
      if(tg && tg.showPopup){
        return new Promise(resolve=>{
          tg.showPopup({
            title: "–£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–ª–∏–∑–∞",
            message: "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–∫–Ω–µ (–æ—Ç–∫—Ä–æ–µ—Ç—Å—è prompt).",
            buttons: [{id:"ok", type:"ok"}, {type:"cancel"}]
          }, (id)=> resolve(id==="ok"));
        });
      }
      return confirm("–£–¥–∞–ª–∏—Ç—å —Ä–µ–ª–∏–∑? –ü–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø—Ä–∏—á–∏–Ω–∞.");
    };

    const ok = await ask();
    if(!ok) return;

    const reason = prompt("–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è:");
    if(!reason || reason.trim().length < 2){
      toast("–ù—É–∂–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞");
      return;
    }

    try{
      const r = await apiPostJSON("/delete_request", { release_id: rid, reason: reason.trim() });
      toast("–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
      if(r.request_id) toast("ID: #" + r.request_id);
      await loadReleases("releasesList", 50);
      await loadReleases("homeLastList", 6);
    }catch(e){
      toast("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å");
    }
  }

  function updateSummary(releases){
    const total = releases.length;
    const pending = releases.filter(x=>x.status==="pending").length;
    const approved = releases.filter(x=>x.status==="approved").length;
    const rejected = releases.filter(x=>x.status==="rejected").length;

    document.getElementById("sumBadge").textContent = total ? (total + " –≤—Å–µ–≥–æ") : "‚Äî";
    document.getElementById("summaryText").innerHTML =
      `pending: <b>${pending}</b><br>`+
      `approved: <b>${approved}</b><br>`+
      `rejected: <b>${rejected}</b>`;
  }

  // =========================
  // SUBMIT RELEASE
  // =========================
  function syncTitleLabel(){
    const t = document.getElementById("s_type").value;
    document.getElementById("s_title_lbl").textContent = (t==="Single") ? "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞" : "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞";
  }
  document.getElementById("s_type").addEventListener("change", syncTitleLabel);
  syncTitleLabel();

  document.getElementById("btnAutoTracklist").addEventListener("click", ()=>{
    const type = document.getElementById("s_type").value;
    const n = Number(document.getElementById("s_tracks").value || 0);
    if(!(type==="Single" && n===1)){
      toast("–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è Single —Å 1 —Ç—Ä–µ–∫–æ–º");
      return;
    }
    const artist = (document.getElementById("s_artist").value || "").trim();
    const title = (document.getElementById("s_title").value || "").trim();
    document.getElementById("s_tracklist").value = `1) ${artist} - ${title}`.trim();
  });

  document.getElementById("btnClearRelease").addEventListener("click", ()=>{
    ["s_artist","s_title","s_fio","s_date","s_tracklist","s_comment"].forEach(id=> document.getElementById(id).value="");
    document.getElementById("s_tracks").value = 1;
    document.getElementById("s_cover").value = "";
    document.getElementById("s_audio").value = "";
    toast("–û—á–∏—â–µ–Ω–æ");
  });

  function isDateDMY(s){
    return /^\d{2}\.\d{2}\.\d{4}$/.test(s);
  }

  document.getElementById("btnSubmitRelease").addEventListener("click", async ()=>{
    const type = document.getElementById("s_type").value;
    const genre = document.getElementById("s_genre").value;
    const artist = (document.getElementById("s_artist").value || "").trim();
    const title  = (document.getElementById("s_title").value || "").trim();
    const fio    = (document.getElementById("s_fio").value || "").trim();
    const date   = (document.getElementById("s_date").value || "").trim();
    const tracks = Number(document.getElementById("s_tracks").value || 0);
    const tracklist = (document.getElementById("s_tracklist").value || "").trim();
    const comment = (document.getElementById("s_comment").value || "").trim();

    const cover = document.getElementById("s_cover").files[0];
    const audios = Array.from(document.getElementById("s_audio").files || []);

    const st = document.getElementById("submitStatus");

    if(!artist || !title || !fio){
      st.textContent = "–ó–∞–ø–æ–ª–Ω–∏: –Ω–∏–∫, –Ω–∞–∑–≤–∞–Ω–∏–µ, –§–ò–û —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).";
      toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–æ–ª–µ–π");
      return;
    }
    if(!isDateDMY(date)){
      st.textContent = "–î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì.";
      return;
    }
    if(!tracks || tracks < 1){
      st.textContent = "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0.";
      return;
    }
    const lines = tracklist.split("\n").map(x=>x.trim()).filter(Boolean);
    if(lines.length !== tracks){
      st.textContent = "–¢—Ä–µ–∫–ª–∏—Å—Ç: –Ω—É–∂–Ω–æ —Ä–æ–≤–Ω–æ N —Å—Ç—Ä–æ–∫ (–∫–∞–∫ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–∫–æ–≤).";
      return;
    }
    if(!cover){
      st.textContent = "–ù—É–∂–Ω–∞ –æ–±–ª–æ–∂–∫–∞ (—Ñ–æ—Ç–æ).";
      return;
    }
    if(audios.length !== tracks){
      st.textContent = "–ù—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–æ–≤–Ω–æ N –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤.";
      return;
    }

    st.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

    try{
      const fd = new FormData();
      fd.append("release_type", type);
      fd.append("genre", genre);
      fd.append("artist_nick", artist);
      fd.append("release_title", title);
      fd.append("participants_fio", fio);
      fd.append("release_date", date);
      fd.append("tracks_count", String(tracks));
      fd.append("tracklist_text", tracklist);
      fd.append("comment", comment);

      fd.append("cover", cover, cover.name || "cover.jpg");
      audios.forEach((f)=> fd.append("audio", f, f.name || "track.mp3"));

      const r = await apiPostMultipart("/submit_release", fd);

      if(r && r.ok){
        st.textContent = "‚úÖ –†–µ–ª–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. ID: #" + (r.release_id || "‚Äî");
        toast("–†–µ–ª–∏–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
        await loadReleases("homeLastList", 6);
      } else {
        st.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.";
      }
    }catch(e){
      st.textContent = "–û—à–∏–±–∫–∞: –ø—Ä–æ–≤–µ—Ä—å API/HTTPS/CORS.";
      toast("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
    }
  });

  // =========================
  // STATS
  // =========================
  document.getElementById("btnSendStats").addEventListener("click", async ()=>{
    const artist = (document.getElementById("st_artist").value || "").trim();
    const release = (document.getElementById("st_release").value || "").trim();
    const streamsRaw = (document.getElementById("st_streams").value || "").trim().replace(/\s+/g,"");
    const comment = (document.getElementById("st_comment").value || "").trim();
    const st = document.getElementById("statsStatus");

    if(!artist || !release || !/^\d+$/.test(streamsRaw)){
      st.textContent = "–ó–∞–ø–æ–ª–Ω–∏: –∞—Ä—Ç–∏—Å—Ç, —Ä–µ–ª–∏–∑, —Å—Ç—Ä–∏–º—ã (—á–∏—Å–ª–æ).";
      return;
    }

    st.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
    try{
      const r = await apiPostJSON("/stats", { artist_name: artist, release_name: release, streams: Number(streamsRaw), comment });
      st.textContent = "‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. ID: #" + (r.report_id || "‚Äî");
      toast("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
    }catch(e){
      st.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å API.";
      toast("–û—à–∏–±–∫–∞");
    }
  });

  // =========================
  // PAYOUT
  // =========================
  let approvedCache = [];

  function approvedItemHTML(r){
    return `
      <div class="item">
        <div class="row">
          <label style="margin:0; display:flex; gap:10px; align-items:center; cursor:pointer;">
            <input type="checkbox" data-appr-id="${r.id}" style="width:20px; height:20px;" />
            <div style="font-weight:950">${escapeHtml(r.release_title || "‚Äî")}</div>
          </label>
          <span class="badge approved">approved</span>
        </div>
        <div class="muted" style="margin-top:6px;">ID: <code>#${r.id}</code> ‚Ä¢ ${escapeHtml(r.created_at || "")}</div>
      </div>`;
  }

  async function loadApproved(){
    const list = document.getElementById("approvedList");
    list.innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;
    try{
      const r = await apiGet("/releases/approved");
      approvedCache = r.releases || [];
      if(!approvedCache.length){
        list.innerHTML = `<div class="muted">–ù–µ—Ç approved —Ä–µ–ª–∏–∑–æ–≤.</div>`;
        return;
      }
      list.innerHTML = approvedCache.map(approvedItemHTML).join("");
    }catch(e){
      list.innerHTML = `<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ approved.</div>`;
    }
  }

  document.getElementById("btnLoadApproved").addEventListener("click", loadApproved);

  document.getElementById("btnSelectAllApproved").addEventListener("click", ()=>{
    document.querySelectorAll("[data-appr-id]").forEach(ch => ch.checked = true);
    toast("–í—ã–±—Ä–∞–Ω–æ");
  });

  document.getElementById("btnSendPayout").addEventListener("click", async ()=>{
    const ids = Array.from(document.querySelectorAll("[data-appr-id]"))
      .filter(x=>x.checked)
      .map(x=>Number(x.getAttribute("data-appr-id")));

    const comment = (document.getElementById("po_comment").value || "").trim();
    const st = document.getElementById("payoutStatus");

    if(!ids.length){
      st.textContent = "–í—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ–ª–∏–∑.";
      return;
    }

    st.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";
    try{
      const r = await apiPostJSON("/payout", { release_ids: ids, comment });
      st.textContent = "‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. ID: #" + (r.request_id || "‚Äî");
      toast("–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–ø–ª–∞—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
    }catch(e){
      st.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.";
      toast("–û—à–∏–±–∫–∞");
    }
  });

  // =========================
  // HOME: actions
  // =========================
  document.getElementById("btnQuickSubmit").addEventListener("click", ()=> showTab("submit"));
  document.getElementById("btnQuickReload").addEventListener("click", async ()=>{
    await pingApi();
    await loadReleases("homeLastList", 6);
  });
  document.getElementById("btnGoReleases").addEventListener("click", ()=> showTab("releases"));
  document.getElementById("btnGoStats").addEventListener("click", ()=> showTab("stats"));
  document.getElementById("btnGoPayout").addEventListener("click", ()=> showTab("payout"));

  document.getElementById("btnReloadReleases").addEventListener("click", ()=> loadReleases("releasesList", 50));
  document.getElementById("btnReloadReleases2").addEventListener("click", ()=> loadReleases("releasesList", 10));

  document.getElementById("btnSearch").addEventListener("click", async ()=>{
    const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
    if(!q){
      toast("–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å");
      return;
    }
    try{
      const r = await apiGet("/releases");
      const arr = (r.releases || []).filter(x => String(x.release_title || "").toLowerCase().includes(q));
      const list = document.getElementById("homeLastList");
      list.innerHTML = arr.slice(0, 10).map(releaseItemHTML).join("") || `<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</div>`;
      wireReleaseButtons(list);
      toast("–ì–æ—Ç–æ–≤–æ");
    }catch(e){
      toast("–ü–æ–∏—Å–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (API)");
    }
  });

  // =========================
  // BOOT
  // =========================
  (async function boot(){
    initTelegramUI();
    await pingApi();
    await loadReleases("homeLastList", 6);
    await loadReleases("releasesList", 20);
  })();
</script>
</body>
</html>